<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:AppInventariCor.Converters"
             x:Class="AppInventariCor.Views.VehiculosPage"
             Title="Vehículos">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <!-- Pantalla de Carga (Visible inicialmente) -->
        <Grid x:Name="LoadingView" 
              IsVisible="{Binding IsInitializing}"
              BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
              VerticalOptions="Fill"
              HorizontalOptions="Fill">

            <VerticalStackLayout HorizontalOptions="Center" 
                                 VerticalOptions="Center" 
                                 Spacing="24">
                <ActivityIndicator IsRunning="True" 
                                   HeightRequest="48" 
                                   WidthRequest="48"
                                   HorizontalOptions="Center" />
                <Label Text="Cargando vehículos..."
                       FontSize="18"
                       HorizontalOptions="Center" />
                <Label Text="{Binding LoadingMessage}"
                       FontSize="14"
                       TextColor="{StaticResource Gray500}"
                       HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Grid>

        <!-- Contenido Principal (Se muestra después de la carga) -->
        <Grid x:Name="MainContent" 
              IsVisible="{Binding IsInitializing, Converter={StaticResource InvertedBoolConverter}}"
              RowDefinitions="Auto,Auto,*" 
              Padding="12" 
              RowSpacing="12">

            <!-- Encabezado y Búsqueda -->
            <Grid Grid.Row="0" RowDefinitions="Auto,Auto,Auto" RowSpacing="8">
                <!-- Barra de búsqueda y botón (sin cambios) -->
                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <SearchBar Placeholder="Buscar vehículo..." 
                  Text="{Binding SearchQuery}"
                  SearchCommand="{Binding SearchCommand}"/>
                    <Button Grid.Column="1" Text="+" 
                HeightRequest="40" WidthRequest="40"
                Command="{Binding AddVehiculoCommand}"/>
                </Grid>

                <!-- Filtros - ahora correctamente en la fila 1 -->
                <Grid Grid.Row="1" ColumnDefinitions="*,*" ColumnSpacing="8" Margin="0,8,0,0">
                    <Picker Title="Filtrar por marca"
                ItemsSource="{Binding MarcasFiltro}"
                SelectedItem="{Binding MarcaSeleccionada}"
                HorizontalOptions="Fill" />

                    <Picker Grid.Column="1"
                Title="Filtrar por propietario"
                ItemsSource="{Binding PropietariosFiltro}"
                SelectedItem="{Binding PropietarioSeleccionado}"
                HorizontalOptions="Fill" />
                </Grid>

                <!-- Selector de búsqueda - ahora correctamente en la fila 2 -->
                <HorizontalStackLayout Grid.Row="2" Spacing="10" Margin="0,8,0,0">
                    <RadioButton Content="Buscar por placa" 
                     IsChecked="{Binding BuscarPorPlaca}"
                     GroupName="tipoBusqueda"/>
                    <RadioButton Content="Buscar por número interno" 
                     IsChecked="{Binding BuscarPorNumeroInterno}"
                     GroupName="tipoBusqueda"/>
                </HorizontalStackLayout>
            </Grid>

            <!-- Estadísticas -->
            <Frame Grid.Row="1" Style="{StaticResource CardFrame}" Padding="12">
                <VerticalStackLayout Spacing="2">
                    <Label Text="Total Vehículos" 
                           FontSize="12" 
                           TextColor="{StaticResource Gray500}" />
                    <Label Text="{Binding TotalVehiculos}" 
                           FontSize="16" 
                           FontAttributes="Bold" />
                </VerticalStackLayout>
            </Frame>

            <!-- Vista de lista -->
            <Grid Grid.Row="2">
                <CollectionView ItemsSource="{Binding Vehiculos}"
                                RemainingItemsThreshold="3"
                                RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">

                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" 
                                            HorizontalOptions="Center"
                                            Spacing="16">
                            <Label Text="No hay vehículos para mostrar" 
                                   HorizontalOptions="Center"
                                   FontSize="16"/>
                            <Button Text="Agregar Vehículo" 
                                    Command="{Binding AddVehiculoCommand}"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Margin="0,4" 
                                   Padding="12" 
                                   Style="{StaticResource CardFrame}">

                                <!-- Añadimos un TapGestureRecognizer al Frame -->
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.VehiculoDetailCommand}" 
                                        CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>

                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                    <!-- Indicador lateral -->
                                    <BoxView WidthRequest="6" 
                                             HeightRequest="50" 
                                             BackgroundColor="{StaticResource Gray400}"
                                             CornerRadius="3" />

                                    <!-- Foto del vehículo (placeholder o real si hay una URL de imagen) -->
                                    <Border Grid.Column="1" 
                                            WidthRequest="60" 
                                            HeightRequest="60"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0"
                                            HorizontalOptions="Start"
                                            VerticalOptions="Center">
                                        <Image Source="directions_bus.png" 
                                               WidthRequest="40" 
                                               HeightRequest="40" 
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"/>
                                    </Border>

                                    <!-- Información del vehículo -->
                                    <VerticalStackLayout Grid.Column="1" 
                                                         Spacing="2"
                                                         Margin="70,0,0,0">
                                        <Label Text="{Binding NumeroPlaca}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"/>
                                        <Label Text="{Binding NumeroInterno, StringFormat='#{0}'}" 
                                               FontSize="13" 
                                               TextColor="{StaticResource Gray500}"/>
                                        <HorizontalStackLayout Spacing="12">
                                            <Label Text="{Binding Marca}" 
                                                   FontSize="13"/>
                                            <Label Text="{Binding Propietario}" 
                                                   FontSize="13" 
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Gray600}"/>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>

                                    <!-- Información adicional opcional -->
                                    <VerticalStackLayout Grid.Column="2" 
                                                        VerticalOptions="Center"
                                                        HorizontalOptions="End">
                                        <Label Text="Ver" 
                                               FontSize="14" 
                                               TextColor="{StaticResource Gray500}"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Botón flotante para añadir vehículo -->
                <Button Text="+"
                        FontSize="24"
                        Command="{Binding AddVehiculoCommand}"
                        WidthRequest="56"
                        HeightRequest="56"
                        CornerRadius="28"
                        HorizontalOptions="End"
                        VerticalOptions="End"
                        Margin="0,0,16,16"
                        BackgroundColor="{StaticResource Black}"
                        TextColor="{StaticResource White}"
                        FontAttributes="Bold"/>

                <!-- Indicador de carga para paginación -->
                <VerticalStackLayout IsVisible="{Binding IsBusy}"
                                    VerticalOptions="End"
                                    HorizontalOptions="Center"
                                    Margin="0,0,0,12">
                    <Frame CornerRadius="20" 
                           Padding="12,8" 
                           HasShadow="True"
                           BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                           BorderColor="Transparent">
                        <HorizontalStackLayout Spacing="8">
                            <ActivityIndicator IsRunning="True" 
                                              WidthRequest="20" 
                                              HeightRequest="20" />
                            <Label Text="Cargando más..." 
                                   FontSize="14"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </Frame>
                </VerticalStackLayout>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>